/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { FormGroup, FormArray } from '@angular/forms';
import { isObject, isNullOrUndefined, isFunction, FORMLY_VALIDATORS, getFieldValue, getKeyPath, removeFieldControl, } from '../../utils';
import { evalExpression, evalStringExpression, evalExpressionValueSetter } from './utils';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';
var FieldExpressionExtension = /** @class */ (function () {
    function FieldExpressionExtension() {
    }
    /**
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype.onPopulate = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        if (field._expressionProperties) {
            return;
        }
        // cache built expression
        field._expressionProperties = field._expressionProperties || {};
        if (field.expressionProperties) {
            var _loop_1 = function (key) {
                /** @type {?} */
                var expressionProperty = field.expressionProperties[key];
                /** @type {?} */
                var expressionValueSetter = evalExpressionValueSetter("field." + key, ['expressionValue', 'model', 'field']);
                if (typeof expressionProperty === 'string' || isFunction(expressionProperty)) {
                    field._expressionProperties[key] = {
                        expression: this_1._evalExpression(expressionProperty, field.parent.expressionProperties && field.parent.expressionProperties.hasOwnProperty('templateOptions.disabled')
                            ? function () { return field.parent.templateOptions.disabled; }
                            : undefined),
                        expressionValueSetter: expressionValueSetter,
                    };
                    if (key === 'templateOptions.disabled') {
                        Object.defineProperty(field._expressionProperties[key], 'expressionValue', {
                            get: function () { return field.templateOptions.disabled; },
                            set: function () { },
                            enumerable: true,
                            configurable: true,
                        });
                    }
                }
                else if (expressionProperty instanceof Observable) {
                    /** @type {?} */
                    var subscription_1 = (/** @type {?} */ (expressionProperty)).pipe(tap(function (v) { return evalExpression(expressionValueSetter, { field: field }, [v, field.model, field]); })).subscribe();
                    /** @type {?} */
                    var onDestroy_1 = field.lifecycle.onDestroy;
                    field.lifecycle.onDestroy = function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        if (onDestroy_1) {
                            onDestroy_1.apply(void 0, tslib_1.__spread(args));
                        }
                        subscription_1.unsubscribe();
                    };
                }
            };
            var this_1 = this;
            for (var key in field.expressionProperties) {
                _loop_1(key);
            }
        }
        if (field.hideExpression || field.parent.hideExpression) {
            // delete hide value in order to force re-evaluate it in FormlyFormExpression.
            delete field.hide;
            field.hideExpression = this._evalExpression(field.hideExpression, field.parent && field.parent.hideExpression ? function () { return field.parent.hide; } : undefined);
        }
        if (!field.options._checkField) {
            field.options._checkField = function (f) { return _this._checkField(f); };
        }
    };
    /**
     * @param {?} expression
     * @param {?=} parentExpression
     * @return {?}
     */
    FieldExpressionExtension.prototype._evalExpression = /**
     * @param {?} expression
     * @param {?=} parentExpression
     * @return {?}
     */
    function (expression, parentExpression) {
        expression = expression || (function () { return false; });
        if (typeof expression === 'string') {
            expression = evalStringExpression(expression, ['model', 'formState']);
        }
        return parentExpression
            ? function (model, formState) { return parentExpression() || expression(model, formState); }
            : expression;
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype._checkField = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        field.fieldGroup.forEach(function (f) {
            _this.checkFieldExpressionChange(f);
            _this.checkFieldVisibilityChange(f);
            if (f.fieldGroup && f.fieldGroup.length > 0) {
                _this._checkField(f);
            }
        });
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype.checkFieldExpressionChange = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        if (!field || !field._expressionProperties) {
            return;
        }
        /** @type {?} */
        var expressionProperties = field._expressionProperties;
        /** @type {?} */
        var validators = FORMLY_VALIDATORS.map(function (v) { return "templateOptions." + v; });
        for (var key in expressionProperties) {
            /** @type {?} */
            var expressionValue = evalExpression(expressionProperties[key].expression, { field: field }, [field.model, field.options.formState]);
            if (key === 'templateOptions.disabled') {
                expressionValue = expressionValue || false;
            }
            if (expressionProperties[key].expressionValue !== expressionValue
                && (!isObject(expressionValue) || JSON.stringify(expressionValue) !== JSON.stringify(expressionProperties[key].expressionValue))) {
                expressionProperties[key].expressionValue = expressionValue;
                evalExpression(expressionProperties[key].expressionValueSetter, { field: field }, [expressionValue, field.model, field]);
                if (key.indexOf('model.') === 0) {
                    /** @type {?} */
                    var path = key.replace(/^model\./, '');
                    /** @type {?} */
                    var control = field.key && key === path ? field.formControl : field.parent.formControl.get(path);
                    if (control
                        && !(isNullOrUndefined(control.value) && isNullOrUndefined(expressionValue))
                        && control.value !== expressionValue) {
                        control.patchValue(expressionValue);
                    }
                }
                if (validators.indexOf(key) !== -1 && field.formControl) {
                    field.formControl.updateValueAndValidity({ emitEvent: false });
                }
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype.checkFieldVisibilityChange = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        if (!field || isNullOrUndefined(field.hideExpression)) {
            return;
        }
        /** @type {?} */
        var hideExpressionResult = !!evalExpression(field.hideExpression, { field: field }, [field.model, field.options.formState]);
        if (hideExpressionResult !== field.hide) {
            // toggle hide
            field.hide = hideExpressionResult;
            field.templateOptions.hidden = hideExpressionResult;
            if (field.formControl && field.key) {
                /** @type {?} */
                var parent_1 = this.fieldParentFormControl(field);
                if (parent_1) {
                    /** @type {?} */
                    var control = parent_1.get("" + this.fieldKey(field));
                    if (hideExpressionResult === true && control) {
                        removeFieldControl(parent_1, this.fieldKey(field));
                    }
                    else if (hideExpressionResult === false && !control) {
                        this.addFieldControl(parent_1, field);
                    }
                }
            }
            if (field.options.fieldChanges) {
                field.options.fieldChanges.next(/** @type {?} */ ({ field: field, type: 'hidden', value: hideExpressionResult }));
            }
        }
    };
    /**
     * @param {?} parent
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype.addFieldControl = /**
     * @param {?} parent
     * @param {?} field
     * @return {?}
     */
    function (parent, field) {
        /** @type {?} */
        var fieldModel = getFieldValue(field);
        if (!(isNullOrUndefined(field.formControl.value) && isNullOrUndefined(fieldModel))
            && field.formControl.value !== fieldModel) {
            field.formControl.patchValue(fieldModel, { emitEvent: false });
        }
        if (parent instanceof FormArray) {
            parent.push(field.formControl);
        }
        else if (parent instanceof FormGroup) {
            parent.addControl("" + this.fieldKey(field), field.formControl);
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype.fieldParentFormControl = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        /** @type {?} */
        var paths = getKeyPath(field);
        paths.pop(); // remove last path
        return /** @type {?} */ ((paths.length > 0 ? field.parent.formControl.get(paths) : field.parent.formControl));
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FieldExpressionExtension.prototype.fieldKey = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        return getKeyPath(field).pop();
    };
    return FieldExpressionExtension;
}());
export { FieldExpressionExtension };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGQtZXhwcmVzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvZXh0ZW5zaW9ucy9maWVsZC1leHByZXNzaW9uL2ZpZWxkLWV4cHJlc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFDTCxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxFQUN2QyxpQkFBaUIsRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLGtCQUFrQixHQUNqRSxNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsY0FBYyxFQUFFLG9CQUFvQixFQUFFLHlCQUF5QixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzFGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JDLElBQUE7Ozs7Ozs7SUFDRSw2Q0FBVTs7OztJQUFWLFVBQVcsS0FBNkI7UUFBeEMsaUJBOERDO1FBN0RDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7WUFDaEMsTUFBTSxDQUFDO1NBQ1I7O1FBR0QsS0FBSyxDQUFDLHFCQUFxQixHQUFHLEtBQUssQ0FBQyxxQkFBcUIsSUFBSSxFQUFFLENBQUM7UUFFaEUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQztvQ0FDcEIsR0FBRzs7Z0JBQ1osSUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBSXREOztnQkFKSixJQUNFLHFCQUFxQixHQUFHLHlCQUF5QixDQUMvQyxXQUFTLEdBQUssRUFDZCxDQUFDLGlCQUFpQixFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FDdEMs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RzVGLDJDQUFROzs7O2NBQUMsS0FBd0I7UUFDdkMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7bUNBek1uQztJQTJNQyxDQUFBO0FBaE1ELG9DQWdNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm1Hcm91cCwgRm9ybUFycmF5IH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seVZhbHVlQ2hhbmdlRXZlbnQsIEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL2Zvcm1seS5maWVsZC5jb25maWcnO1xuaW1wb3J0IHtcbiAgaXNPYmplY3QsIGlzTnVsbE9yVW5kZWZpbmVkLCBpc0Z1bmN0aW9uLFxuICBGT1JNTFlfVkFMSURBVE9SUywgZ2V0RmllbGRWYWx1ZSwgZ2V0S2V5UGF0aCwgcmVtb3ZlRmllbGRDb250cm9sLFxufSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBldmFsRXhwcmVzc2lvbiwgZXZhbFN0cmluZ0V4cHJlc3Npb24sIGV2YWxFeHByZXNzaW9uVmFsdWVTZXR0ZXIgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvcm1seUV4dGVuc2lvbiB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Zvcm1seS5jb25maWcnO1xuXG5leHBvcnQgY2xhc3MgRmllbGRFeHByZXNzaW9uRXh0ZW5zaW9uIGltcGxlbWVudHMgRm9ybWx5RXh0ZW5zaW9uIHtcbiAgb25Qb3B1bGF0ZShmaWVsZDogRm9ybWx5RmllbGRDb25maWdDYWNoZSkge1xuICAgIGlmIChmaWVsZC5fZXhwcmVzc2lvblByb3BlcnRpZXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBjYWNoZSBidWlsdCBleHByZXNzaW9uXG4gICAgZmllbGQuX2V4cHJlc3Npb25Qcm9wZXJ0aWVzID0gZmllbGQuX2V4cHJlc3Npb25Qcm9wZXJ0aWVzIHx8IHt9O1xuXG4gICAgaWYgKGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcykge1xuICAgICAgICBjb25zdCBleHByZXNzaW9uUHJvcGVydHkgPSBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldLFxuICAgICAgICAgIGV4cHJlc3Npb25WYWx1ZVNldHRlciA9IGV2YWxFeHByZXNzaW9uVmFsdWVTZXR0ZXIoXG4gICAgICAgICAgICBgZmllbGQuJHtrZXl9YCxcbiAgICAgICAgICAgIFsnZXhwcmVzc2lvblZhbHVlJywgJ21vZGVsJywgJ2ZpZWxkJ10sXG4gICAgICAgICAgKTtcblxuICAgICAgICBpZiAodHlwZW9mIGV4cHJlc3Npb25Qcm9wZXJ0eSA9PT0gJ3N0cmluZycgfHwgaXNGdW5jdGlvbihleHByZXNzaW9uUHJvcGVydHkpKSB7XG4gICAgICAgICAgZmllbGQuX2V4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0gPSB7XG4gICAgICAgICAgICBleHByZXNzaW9uOiB0aGlzLl9ldmFsRXhwcmVzc2lvbihcbiAgICAgICAgICAgICAgZXhwcmVzc2lvblByb3BlcnR5LFxuICAgICAgICAgICAgICBmaWVsZC5wYXJlbnQuZXhwcmVzc2lvblByb3BlcnRpZXMgJiYgZmllbGQucGFyZW50LmV4cHJlc3Npb25Qcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KCd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnKVxuICAgICAgICAgICAgICAgID8gKCkgPT4gZmllbGQucGFyZW50LnRlbXBsYXRlT3B0aW9ucy5kaXNhYmxlZFxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGV4cHJlc3Npb25WYWx1ZVNldHRlcixcbiAgICAgICAgICB9O1xuICAgICAgICAgIGlmIChrZXkgPT09ICd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnKSB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmllbGQuX2V4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0sICdleHByZXNzaW9uVmFsdWUnLCB7XG4gICAgICAgICAgICAgIGdldDogKCkgPT4gZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkLFxuICAgICAgICAgICAgICBzZXQ6ICgpID0+IHsgfSxcbiAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGV4cHJlc3Npb25Qcm9wZXJ0eSBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSAoZXhwcmVzc2lvblByb3BlcnR5IGFzIE9ic2VydmFibGU8YW55PikucGlwZShcbiAgICAgICAgICAgIHRhcCh2ID0+IGV2YWxFeHByZXNzaW9uKGV4cHJlc3Npb25WYWx1ZVNldHRlciwgeyBmaWVsZCB9LCBbdiwgZmllbGQubW9kZWwsIGZpZWxkXSkpLFxuICAgICAgICAgICkuc3Vic2NyaWJlKCk7XG5cbiAgICAgICAgICBjb25zdCBvbkRlc3Ryb3kgPSBmaWVsZC5saWZlY3ljbGUub25EZXN0cm95O1xuICAgICAgICAgIGZpZWxkLmxpZmVjeWNsZS5vbkRlc3Ryb3kgPSAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgaWYgKG9uRGVzdHJveSkge1xuICAgICAgICAgICAgICBvbkRlc3Ryb3koLi4uYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLmhpZGVFeHByZXNzaW9uIHx8IGZpZWxkLnBhcmVudC5oaWRlRXhwcmVzc2lvbikge1xuICAgICAgLy8gZGVsZXRlIGhpZGUgdmFsdWUgaW4gb3JkZXIgdG8gZm9yY2UgcmUtZXZhbHVhdGUgaXQgaW4gRm9ybWx5Rm9ybUV4cHJlc3Npb24uXG4gICAgICBkZWxldGUgZmllbGQuaGlkZTtcbiAgICAgIGZpZWxkLmhpZGVFeHByZXNzaW9uID0gdGhpcy5fZXZhbEV4cHJlc3Npb24oXG4gICAgICAgIGZpZWxkLmhpZGVFeHByZXNzaW9uLFxuICAgICAgICBmaWVsZC5wYXJlbnQgJiYgZmllbGQucGFyZW50LmhpZGVFeHByZXNzaW9uID8gKCkgPT4gZmllbGQucGFyZW50LmhpZGUgOiB1bmRlZmluZWQsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghZmllbGQub3B0aW9ucy5fY2hlY2tGaWVsZCkge1xuICAgICAgZmllbGQub3B0aW9ucy5fY2hlY2tGaWVsZCA9IChmKSA9PiB0aGlzLl9jaGVja0ZpZWxkKGYpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2V2YWxFeHByZXNzaW9uKGV4cHJlc3Npb24sIHBhcmVudEV4cHJlc3Npb24/KSB7XG4gICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24gfHwgKCgpID0+IGZhbHNlKTtcbiAgICBpZiAodHlwZW9mIGV4cHJlc3Npb24gPT09ICdzdHJpbmcnKSB7XG4gICAgICBleHByZXNzaW9uID0gZXZhbFN0cmluZ0V4cHJlc3Npb24oZXhwcmVzc2lvbiwgWydtb2RlbCcsICdmb3JtU3RhdGUnXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmVudEV4cHJlc3Npb25cbiAgICAgID8gKG1vZGVsOiBhbnksIGZvcm1TdGF0ZTogYW55KSA9PiBwYXJlbnRFeHByZXNzaW9uKCkgfHwgZXhwcmVzc2lvbihtb2RlbCwgZm9ybVN0YXRlKVxuICAgICAgOiBleHByZXNzaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2hlY2tGaWVsZChmaWVsZDogRm9ybWx5RmllbGRDb25maWdDYWNoZSkge1xuICAgIGZpZWxkLmZpZWxkR3JvdXAuZm9yRWFjaChmID0+IHtcbiAgICAgIHRoaXMuY2hlY2tGaWVsZEV4cHJlc3Npb25DaGFuZ2UoZik7XG4gICAgICB0aGlzLmNoZWNrRmllbGRWaXNpYmlsaXR5Q2hhbmdlKGYpO1xuXG4gICAgICBpZiAoZi5maWVsZEdyb3VwICYmIGYuZmllbGRHcm91cC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuX2NoZWNrRmllbGQoZik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRmllbGRFeHByZXNzaW9uQ2hhbmdlKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZ0NhY2hlKSB7XG4gICAgaWYgKCFmaWVsZCB8fCAhZmllbGQuX2V4cHJlc3Npb25Qcm9wZXJ0aWVzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZXhwcmVzc2lvblByb3BlcnRpZXMgPSBmaWVsZC5fZXhwcmVzc2lvblByb3BlcnRpZXM7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IEZPUk1MWV9WQUxJREFUT1JTLm1hcCh2ID0+IGB0ZW1wbGF0ZU9wdGlvbnMuJHt2fWApO1xuXG4gICAgZm9yIChjb25zdCBrZXkgaW4gZXhwcmVzc2lvblByb3BlcnRpZXMpIHtcbiAgICAgIGxldCBleHByZXNzaW9uVmFsdWUgPSBldmFsRXhwcmVzc2lvbihleHByZXNzaW9uUHJvcGVydGllc1trZXldLmV4cHJlc3Npb24sIHsgZmllbGQgfSwgW2ZpZWxkLm1vZGVsLCBmaWVsZC5vcHRpb25zLmZvcm1TdGF0ZV0pO1xuICAgICAgaWYgKGtleSA9PT0gJ3RlbXBsYXRlT3B0aW9ucy5kaXNhYmxlZCcpIHtcbiAgICAgICAgZXhwcmVzc2lvblZhbHVlID0gZXhwcmVzc2lvblZhbHVlIHx8IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBpZiAoXG4gICAgICAgIGV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0uZXhwcmVzc2lvblZhbHVlICE9PSBleHByZXNzaW9uVmFsdWVcbiAgICAgICAgJiYgKCFpc09iamVjdChleHByZXNzaW9uVmFsdWUpIHx8IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25WYWx1ZSkgIT09IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0uZXhwcmVzc2lvblZhbHVlKSlcbiAgICAgICkge1xuICAgICAgICBleHByZXNzaW9uUHJvcGVydGllc1trZXldLmV4cHJlc3Npb25WYWx1ZSA9IGV4cHJlc3Npb25WYWx1ZTtcbiAgICAgICAgZXZhbEV4cHJlc3Npb24oXG4gICAgICAgICAgZXhwcmVzc2lvblByb3BlcnRpZXNba2V5XS5leHByZXNzaW9uVmFsdWVTZXR0ZXIsXG4gICAgICAgICAgeyBmaWVsZCB9LFxuICAgICAgICAgIFtleHByZXNzaW9uVmFsdWUsIGZpZWxkLm1vZGVsLCBmaWVsZF0sXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGtleS5pbmRleE9mKCdtb2RlbC4nKSA9PT0gMCkge1xuICAgICAgICAgIGNvbnN0IHBhdGggPSBrZXkucmVwbGFjZSgvXm1vZGVsXFwuLywgJycpLFxuICAgICAgICAgICAgY29udHJvbCA9IGZpZWxkLmtleSAmJiBrZXkgPT09IHBhdGggPyBmaWVsZC5mb3JtQ29udHJvbCA6IGZpZWxkLnBhcmVudC5mb3JtQ29udHJvbC5nZXQocGF0aCk7XG5cbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBjb250cm9sXG4gICAgICAgICAgICAmJiAhKGlzTnVsbE9yVW5kZWZpbmVkKGNvbnRyb2wudmFsdWUpICYmIGlzTnVsbE9yVW5kZWZpbmVkKGV4cHJlc3Npb25WYWx1ZSkpXG4gICAgICAgICAgICAmJiBjb250cm9sLnZhbHVlICE9PSBleHByZXNzaW9uVmFsdWVcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnRyb2wucGF0Y2hWYWx1ZShleHByZXNzaW9uVmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWxpZGF0b3JzLmluZGV4T2Yoa2V5KSAhPT0gLTEgJiYgZmllbGQuZm9ybUNvbnRyb2wpIHtcbiAgICAgICAgICBmaWVsZC5mb3JtQ29udHJvbC51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tGaWVsZFZpc2liaWxpdHlDaGFuZ2UoZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUpIHtcbiAgICBpZiAoIWZpZWxkIHx8IGlzTnVsbE9yVW5kZWZpbmVkKGZpZWxkLmhpZGVFeHByZXNzaW9uKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGhpZGVFeHByZXNzaW9uUmVzdWx0OiBib29sZWFuID0gISFldmFsRXhwcmVzc2lvbihcbiAgICAgIGZpZWxkLmhpZGVFeHByZXNzaW9uLFxuICAgICAgeyBmaWVsZCB9LFxuICAgICAgW2ZpZWxkLm1vZGVsLCBmaWVsZC5vcHRpb25zLmZvcm1TdGF0ZV0sXG4gICAgKTtcblxuICAgIGlmIChoaWRlRXhwcmVzc2lvblJlc3VsdCAhPT0gZmllbGQuaGlkZSkge1xuICAgICAgLy8gdG9nZ2xlIGhpZGVcbiAgICAgIGZpZWxkLmhpZGUgPSBoaWRlRXhwcmVzc2lvblJlc3VsdDtcbiAgICAgIGZpZWxkLnRlbXBsYXRlT3B0aW9ucy5oaWRkZW4gPSBoaWRlRXhwcmVzc2lvblJlc3VsdDtcblxuICAgICAgaWYgKGZpZWxkLmZvcm1Db250cm9sICYmIGZpZWxkLmtleSkge1xuICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmZpZWxkUGFyZW50Rm9ybUNvbnRyb2woZmllbGQpO1xuICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgY29uc3QgY29udHJvbCA9IHBhcmVudC5nZXQoYCR7dGhpcy5maWVsZEtleShmaWVsZCl9YCk7XG4gICAgICAgICAgaWYgKGhpZGVFeHByZXNzaW9uUmVzdWx0ID09PSB0cnVlICYmIGNvbnRyb2wpIHtcbiAgICAgICAgICAgIHJlbW92ZUZpZWxkQ29udHJvbChwYXJlbnQsIHRoaXMuZmllbGRLZXkoZmllbGQpKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGhpZGVFeHByZXNzaW9uUmVzdWx0ID09PSBmYWxzZSAmJiAhY29udHJvbCkge1xuICAgICAgICAgICAgdGhpcy5hZGRGaWVsZENvbnRyb2wocGFyZW50LCBmaWVsZCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChmaWVsZC5vcHRpb25zLmZpZWxkQ2hhbmdlcykge1xuICAgICAgICBmaWVsZC5vcHRpb25zLmZpZWxkQ2hhbmdlcy5uZXh0KDxGb3JtbHlWYWx1ZUNoYW5nZUV2ZW50PiB7IGZpZWxkOiBmaWVsZCwgdHlwZTogJ2hpZGRlbicsIHZhbHVlOiBoaWRlRXhwcmVzc2lvblJlc3VsdCB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZEZpZWxkQ29udHJvbChwYXJlbnQ6IEZvcm1BcnJheSB8IEZvcm1Hcm91cCwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgY29uc3QgZmllbGRNb2RlbCA9IGdldEZpZWxkVmFsdWUoZmllbGQpO1xuICAgIGlmIChcbiAgICAgICEoaXNOdWxsT3JVbmRlZmluZWQoZmllbGQuZm9ybUNvbnRyb2wudmFsdWUpICYmIGlzTnVsbE9yVW5kZWZpbmVkKGZpZWxkTW9kZWwpKVxuICAgICAgJiYgZmllbGQuZm9ybUNvbnRyb2wudmFsdWUgIT09IGZpZWxkTW9kZWxcbiAgICApIHtcbiAgICAgIGZpZWxkLmZvcm1Db250cm9sLnBhdGNoVmFsdWUoZmllbGRNb2RlbCwgeyBlbWl0RXZlbnQ6IGZhbHNlIH0pO1xuICAgIH1cblxuICAgIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBGb3JtQXJyYXkpIHtcbiAgICAgIHBhcmVudC5wdXNoKGZpZWxkLmZvcm1Db250cm9sKTtcbiAgICB9IGVsc2UgaWYgKHBhcmVudCBpbnN0YW5jZW9mIEZvcm1Hcm91cCkge1xuICAgICAgcGFyZW50LmFkZENvbnRyb2woYCR7dGhpcy5maWVsZEtleShmaWVsZCl9YCwgZmllbGQuZm9ybUNvbnRyb2wpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZmllbGRQYXJlbnRGb3JtQ29udHJvbChmaWVsZDogRm9ybWx5RmllbGRDb25maWcpOiBGb3JtQXJyYXkgfCBGb3JtR3JvdXAge1xuICAgIGNvbnN0IHBhdGhzID0gZ2V0S2V5UGF0aChmaWVsZCk7XG4gICAgcGF0aHMucG9wKCk7IC8vIHJlbW92ZSBsYXN0IHBhdGhcblxuICAgIHJldHVybiAocGF0aHMubGVuZ3RoID4gMCA/IGZpZWxkLnBhcmVudC5mb3JtQ29udHJvbC5nZXQocGF0aHMpIDogZmllbGQucGFyZW50LmZvcm1Db250cm9sKSBhcyBhbnk7XG4gIH1cblxuICBwcml2YXRlIGZpZWxkS2V5KGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZykge1xuICAgIHJldHVybiBnZXRLZXlQYXRoKGZpZWxkKS5wb3AoKTtcbiAgfVxufVxuIl19